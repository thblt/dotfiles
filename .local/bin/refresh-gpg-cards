#!/bin/sh

# This script helps the gpg-ssh-agent and git work correctly with
# multiple sign and encryption subkeys stored on multiple smartcards.
# It reads the smartcard status and (re)creates ~/.gnupg/sshcontrol
# and ~/.config/git/signingkey with the keygrip of an A and U subkey,
# respectively, present on a connected smartcard.
#
# This can probably be called from an udev rule, at each smartcard
# insertion/deletion.  It should fail cleanly if no card is connected.
#
# Notice that git doesn't read ~/.config/git/signingkey, it needs to
# be Includeâ€™d from the main config, like this
# [Include]
# path = "~/.config/git/signingkey"
#
# Limitations:
#  - Only works with a single smartcard.  This is a hard limitation in
#    git where you can only provide a single user.signingkey, but
#    there could be multiple keygrips in sshcontrol.  Supporting
#    multiple smartcards may also allow to prefer unlocked
#    smartcards/subkeys.
#
#  - It calls gpg with the default output format instead of properly
#    parsable ` --with-colons --status-fd=v2`

set -e
export LANG=C

# Update gitconfig
key_s=$(gpg --card-status | grep "^Signature key" | cut -d: -f2 | sed "s/ //g")
echo "[user]" > ~/.config/git/signingkey
echo "  signingkey = 0x$key_s" >> ~/.config/git/signingkey

# Update sshcontrol
card_sn=$(gpg --card-status | grep "^Serial number" | cut -d " " -f4)
gpg -K --with-subkey-fingerprint --with-keygrip \
    | grep -B3 -A1 "^      Card serial no. = .* $card_sn" \
    | grep -A 3 "\\[A\\]$f" \
    | tail -n 1 \
    | cut -d " " -f 9 > ~/.gnupg/sshcontrol

LANG=C
